{% extends "base.html" %}

{% block content %}
<div style="max-width: 800px; margin: 2rem auto;">
    <h1 style="color: var(--primary-color);">M콢j Profil 游녻</h1>

    <!-- User Info Card -->
    <div class="card" style="margin-bottom: 2rem;">
        <h2>Osobn칤 칔daje</h2>
        <div class="form-group">
            <label>Jm칠no</label>
            <p id="profile-name" style="font-weight: 500;">Na캜칤t치m...</p>
        </div>
        <div class="form-group">
            <label>Email</label>
            <p id="profile-email" style="font-weight: 500;">Na캜칤t치m...</p>
        </div>
        <div class="form-group">
            <label>Aktu치ln칤 Tarif</label>
            <span id="profile-tier" class="badge" style="font-size: 1rem;">...</span>
        </div>
    </div>

    <!-- Subscription Management -->
    <div class="card" style="margin-bottom: 2rem; border-left: 5px solid var(--accent-color);">
        <h2>Nastaven칤 P콏edplatn칠ho 游눱</h2>
        <p>Spravujte sv칠 faktura캜n칤 칰daje, stahujte faktury nebo zm캩켿te tarif.</p>

        <div id="sub-actions" style="margin-top: 1.5rem;">
            <!-- Dynamic Buttons injected via JS -->
            <button class="btn-primary" onclick="manageBilling()">Na캜칤t치m mo쬹osti...</button>
        </div>
    </div>

    <!-- Legal Section -->
    <div class="card">
        <h2>Pr치vn칤 Informace 丘뒲잺</h2>
        <ul style="list-style: none; padding: 0;">
            <li style="margin-bottom: 0.5rem;"><a href="#" onclick="alert('TODO: Vlo쬴t VOP')"
                    style="color: inherit; text-decoration: underline;">Obchodn칤 podm칤nky (VOP)</a></li>
            <li style="margin-bottom: 0.5rem;"><a href="#" onclick="alert('TODO: GDPR')"
                    style="color: inherit; text-decoration: underline;">Ochrana osobn칤ch 칰daj콢 (GDPR)</a></li>
            <li><a href="#" onclick="alert('TODO: Cookies')"
                    style="color: inherit; text-decoration: underline;">Nastaven칤 Cookies</a></li>
        </ul>
        <hr style="margin: 1.5rem 0; opacity: 0.2;">
        <button class="btn-text" style="color: var(--danger-color);" onclick="deleteAccount()">Smazat 칰캜et</button>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", async () => {
        const token = localStorage.getItem('access_token');
        if (!token) {
            window.location.href = '/login';
            return;
        }

        // Decode JWT locally for simple display (or fetch user profile endpoint if we had one)
        // For MVP, we parse the JWT payload manually
        try {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function (c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            const user = JSON.parse(jsonPayload);

            document.getElementById('profile-email').innerText = user.sub; // Email is subject
            document.getElementById('profile-tier').innerText = user.tier || "BASIC";
            document.getElementById('profile-name').innerText = "U쬴vatel"; // JWT doesn't have name currently

            setupButtons(user.sub, user.tier);

        } catch (e) {
            console.error("Token error", e);
            logout();
        }
    });

    function setupButtons(email, tier) {
        const container = document.getElementById('sub-actions');
        container.innerHTML = "";

        if (tier === "BASIC") {
            // Upsell
            container.innerHTML = `
                <p style="margin-bottom:1rem; color:#666;">Pr치v캩 vyu쮂셨치te z치kladn칤 verzi zdarma.</p>
                <a href="/register" class="btn-primary">Upgradovat na Business</a>
            `;
        } else {
            // Manage Subscription (Stripe Portal)
            const btn = document.createElement('button');
            btn.className = "btn-secondary";
            btn.innerText = "Spravovat fakturaci / Zm캩nit tarif";
            btn.onclick = () => openStripePortal(email);
            container.appendChild(btn);
        }
    }

    async function openStripePortal(email) {
        const btn = document.querySelector('#sub-actions button');
        btn.innerText = "P콏esm캩rov치v치m...";
        btn.disabled = true;

        try {
            // Reuse CheckoutRequest structure: price_id is dummy
            const response = await fetch('/payment/create-portal-session', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    price_id: 'portal',
                    user_email: email
                })
            });

            const data = await response.json();
            if (data.url) {
                window.location.href = data.url;
            } else {
                alert("Chyba: " + (data.error || "Nelze otev콏칤t port치l."));
                btn.innerText = "Spravovat fakturaci";
                btn.disabled = false;
            }
        } catch (e) {
            alert("Chyba p콏i komunikaci se serverem.");
            btn.disabled = false;
        }
    }

    function deleteAccount() {
        if (confirm("Opravdu chcete smazat 칰캜et? Tato akce je nevratn치.")) {
            alert("Po쬬davek odesl치n na podporu (demo).");
        }
    }
</script>
{% endblock %}