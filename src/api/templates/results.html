{% extends "index.html" %}

{% block results %}
{% if results %}
<p>Nalezeno {{ results|length }} nemovitost√≠. Analyzov√°no na z√°kladƒõ nativn√≠ho API hled√°n√≠.</p>
<div class="cards-grid">
    {% for item in results %}
    <div class="card property-card" onclick="window.open('{{ item.ad.source_url }}', '_blank')"
        style="cursor: pointer;">

        <!-- Image -->
        <div class="card-image">
            <img src="{{ item.ad.images[0] if item.ad.images else 'https://via.placeholder.com/300x200?text=No+Image' }}"
                loading="lazy" alt="Property">
        </div>

        <!-- Content -->
        <div class="card-content">
            <h3><a href="{{ item.ad.source_url }}" target="_blank">{{ item.ad.title }}</a></h3>
            <p class="location">üìç {{ item.ad.locality }}</p>

            <!-- Rating Moved Here -->
            <p
                style="font-size: 0.9rem; margin-top: -0.5rem; margin-bottom: 0.5rem; color: {{ 'var(--success-color)' if item.metrics.is_good_deal else '#777' }}">
                <strong>Hodnocen√≠:</strong> {{ 'V√Ωborn√° (A)' if item.metrics.is_good_deal else 'Ostatn√≠ (B)' }}
            </p>


            <div class="stats-row">
                <div>
                    <span class="label">Cena</span>
                    <span class="value">{{ "{:,}".format(item.ad.price_czk).replace(',', ' ') }} Kƒç</span>
                </div>
                <div>
                    <span class="label">Odh. n√°jem</span>
                    <span class="value">{{ "{:,}".format(item.metrics.estimated_annual_rent_czk // 12).replace(',', ' ')
                        }} /mƒõs</span>
                </div>
            </div>

            <div class="stats-row highlight">
                <div>
                    <span class="label">N√°jem/m¬≤</span>
                    <span class="value">{{ item.metrics.monthly_rent_per_m2 }} Kƒç/m¬≤</span>
                </div>
                <div>
                    <span class="label">Tr≈æn√≠ Pr≈Ømƒõr</span>
                    <span class="value">{{ "{:,}".format(item.metrics.market_sale_per_m2).replace(',', ' ') }}</span>
                </div>
            </div>

            <div style="margin-top:0.5rem; display:flex; justify-content:space-between; align-items:center;">
                <!-- AI Button -->
                <button class="btn-secondary"
                    style="font-size: 0.8rem; padding: 0.3rem 0.8rem; background: linear-gradient(135deg, #6e8efb, #a777e3); color:white; border:none;"
                    onclick="analyzeProperty('{{ item.ad.source_url.split('/')[-1] }}', '{{ item.ad.title|escape }}', {{ item.ad.price_raw|replace(' ', '')|int }}, {{ item.metrics.gross_yield_percent }}); event.stopPropagation();">
                    ‚ú® AI Anal√Ωza
                </button>

                <div>
                    <span class="label">vs Trh: </span>
                    <span
                        style="font-weight:bold; color: {{ 'var(--success-color)' if item.metrics.undervaluation_percent > 0 else 'var(--danger-color)' }}">
                        {{ "{:+.1f}".format(item.metrics.undervaluation_percent) }}%
                    </span>
                </div>
            </div>

        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="no-results">
    <p>≈Ω√°dn√© v√Ωsledky. Zkuste jin√Ω dotaz (nap≈ô. "Byt v Praze do 5M").</p>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<!-- AI Modal -->
<div id="ai-modal"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999; justify-content:center; align-items:center;">
    <div class="card"
        style="width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; background:white; position:relative;">
        <div
            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; border-bottom:1px solid #eee; padding-bottom:0.5rem;">
            <h2
                style="margin:0; background: -webkit-linear-gradient(45deg, #6e8efb, #a777e3); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                AI Investiƒçn√≠ Anal√Ωza üß†</h2>
            <button onclick="document.getElementById('ai-modal').style.display='none'"
                style="border:none; background:none; font-size:2rem; cursor:pointer; line-height:1;">&times;</button>
        </div>
        <div id="ai-content" style="min-height:200px;">
            <div style="text-align:center; padding:2rem;">
                <div class="spinner" style="font-size:2rem;">ü§ñ</div>
                <p>Analyzuji inzer√°t, poƒçkejte pros√≠m...</p>
            </div>
        </div>
    </div>
</div>

<script>
    async function analyzeProperty(hashId, title, price, yieldPct) {
        const modal = document.getElementById('ai-modal');
        const content = document.getElementById('ai-content');
        modal.style.display = 'flex';
        content.innerHTML = `
        <div style="text-align:center; padding:2rem;">
            <div style="font-size:3rem; margin-bottom:1rem;">ü§ñ</div>
            <p style="font-size:1.1rem; color:#666;">Naƒç√≠t√°m detail inzer√°tu a prov√°d√≠m SWOT anal√Ωzu...</p>
        </div>
    `;

        try {
            const resp = await fetch('/api/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ hash_id: parseInt(hashId), title: title, price: price, yield_pct: yieldPct })
            });
            const data = await resp.json();

            if (data.error) {
                content.innerHTML = `<p style="color:var(--danger-color); text-align:center; padding:2rem;"><strong>Chyba:</strong> ${data.error}</p>`;
                return;
            }

            // Render Result
            let html = `
            <div style="background:var(--bg-color); padding:1rem; border-radius:8px; margin-bottom:1.5rem; text-align:center;">
                <div style="font-size:1.2rem; font-weight:bold; margin-bottom:0.5rem;">Celkov√© Sk√≥re</div>
                <div style="font-size:2.5rem; font-weight:800; color:${data.score > 75 ? 'var(--success-color)' : (data.score < 50 ? 'var(--danger-color)' : 'orange')}">
                    ${data.score}/100
                </div>
                <p style="margin-bottom:0; font-style:italic;">"${data.verdict}"</p>
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:1.5rem;">
                <div style="background:#f0fff4; padding:1rem; border-radius:8px; border:1px solid #c6f6d5;">
                    <h3 style="color:#276749; margin-top:0;">‚úÖ Siln√© str√°nky</h3>
                    <ul style="padding-left:1.2rem; margin-bottom:0;">
                        ${data.strengths.map(s => `<li>${s}</li>`).join('')}
                    </ul>
                </div>
                <div style="background:#fff5f5; padding:1rem; border-radius:8px; border:1px solid #fed7d7;">
                    <h3 style="color:#9b2c2c; margin-top:0;">‚ùå Rizika / Slabiny</h3>
                    <ul style="padding-left:1.2rem; margin-bottom:0;">
                        ${data.weaknesses.map(s => `<li>${s}</li>`).join('')}
                    </ul>
                </div>
            </div>
            <div style="margin-top:1rem; text-align:center; font-size:0.8rem; color:#999;">
                Generov√°no AI modelem (GPT-4o/Mock). Neslou≈æ√≠ jako finanƒçn√≠ poradenstv√≠.
            </div>
        `;
            content.innerHTML = html;

        } catch (e) {
            content.innerHTML = `<p style="color:red; text-align:center;">Chyba komunikace se serverem. Zkuste to znovu.</p>`;
            console.error(e);
        }
    }
</script>
{% endblock %}